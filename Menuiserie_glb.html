<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Configurateur Menuiserie Babylon.js</title>
  <style>
    html, body { margin: 0; height: 100%; overflow: hidden; }
    canvas { width: 100%; height: 100%; display: block; }
    #ui {
      position: absolute;
      top: 10px;
      left: 10px;
      background: white;
      padding: 10px;
      z-index: 1;
      font-family: sans-serif;
    }
    label { display: block; margin-top: 5px; }
  </style>
</head>
<body>
  <div id="ui">
    <label>Largeur (mm): <input type="number" id="width" value="1200"></label>
    <label>Hauteur (mm): <input type="number" id="height" value="2150"></label>

    <label>Ajouter allège :
      <input type="checkbox" id="addAllege">
    </label>
    <div id="allegeHeightSection" style="display: none;">
      <label>Hauteur allège (mm) : <input type="number" id="allegeHeight" value="300"></label>
    </div>

    <label>Ajouter imposte :
      <input type="checkbox" id="addImposte">
    </label>
    <div id="imposteHeightSection" style="display: none;">
      <label>Hauteur imposte (mm) : <input type="number" id="imposteHeight" value="300"></label>
    </div>

    <label>Nombre de vantaux :
      <select id="vantaux">
        <option value="1">1</option>
        <option value="2" selected>2</option>
        <option value="3">3</option>
        <option value="4">4</option>
      </select>
    </label>

    <label>Couleur :
      <select id="couleur">
        <option value="Ral 1015">Ral 1015</option>
        <option value="Ral 3004" selected>Ral 3004</option>
        <option value="Ral 5014">Ral 5014</option>
        <option value="Ral 6019">Ral 6019</option>
        <option value="Ral 7016">Ral 7016</option>
        <option value="Ral 9005">Ral 9005</option>
        <option value="Ral 9010">Ral 9010</option>
      </select>
    </label>

    <label>Ajouter vitrage :
      <input type="checkbox" id="vitrage" checked>
    </label>

    <label><button id="toggleVantaux">Ouvrir les ouvrants</button></label>
    <label><button id="updateBtn">Mettre à jour</button></label>
  </div>

  <canvas id="renderCanvas"></canvas>

  <script src="https://cdn.babylonjs.com/babylon.js"></script>
  <script src="https://cdn.babylonjs.com/loaders/babylonjs.loaders.min.js"></script>

  <script>
    const canvas = document.getElementById("renderCanvas");
    const engine = new BABYLON.Engine(canvas, true);
    const scene = new BABYLON.Scene(engine);
    scene.clearColor = new BABYLON.Color3(0.9, 0.9, 0.95);

    const camera = new BABYLON.ArcRotateCamera("camera", Math.PI / 3 + Math.PI, Math.PI / 3, 5, BABYLON.Vector3.Zero(), scene);
    camera.attachControl(canvas, true);
    camera.wheelPrecision = 20;
    camera.lowerRadiusLimit = 1.5;
    camera.upperRadiusLimit = 20;

    const light = new BABYLON.HemisphericLight("light", new BABYLON.Vector3(1, 1, 0), scene);
    const directionalLight = new BABYLON.DirectionalLight("dirLight", new BABYLON.Vector3(0, -1, 1), scene);

    const shadowGenerator = new BABYLON.ShadowGenerator(1024, directionalLight);
    shadowGenerator.useExponentialShadowMap = true;

    const ralColors = {
      "Ral 1015": new BABYLON.Color3.FromHexString("#FBE8A6"),
      "Ral 3004": new BABYLON.Color3.FromHexString("#641C34"),
      "Ral 5014": new BABYLON.Color3.FromHexString("#5B6470"),
      "Ral 6019": new BABYLON.Color3.FromHexString("#5D8C45"),
      "Ral 7016": new BABYLON.Color3.FromHexString("#383E42"),
      "Ral 9005": new BABYLON.Color3.FromHexString("#0A0A0A"),
      "Ral 9010": new BABYLON.Color3.FromHexString("#FFFFFF")
    };

    let loadedMeshes = [];

    // Affichage dynamique
    document.getElementById("addAllege").addEventListener("change", function () {
      document.getElementById("allegeHeightSection").style.display = this.checked ? "block" : "none";
    });
    document.getElementById("addImposte").addEventListener("change", function () {
      document.getElementById("imposteHeightSection").style.display = this.checked ? "block" : "none";
    });

    // Charger le modèle
    BABYLON.SceneLoader.ImportMesh(
      null,
      "https://jjgodard-itc.github.io/menuiserie/",
      "Menuiserie.glb",
      scene,
      function (meshes) {
        loadedMeshes = meshes;
        applyColor();
      },
      null,
      function (scene, message) {
        console.error("Erreur de chargement :", message);
      }
    );

    // Appliquer couleur
    function applyColor() {
      const color = ralColors[document.getElementById("couleur").value];
      loadedMeshes.forEach(mesh => {
        if (mesh.material) {
          const mat = mesh.material.clone(mesh.name + "_mat");
          if (mat.diffuseColor) mat.diffuseColor = color;
          mesh.material = mat;
        }
      });
    }

    document.getElementById("couleur").addEventListener("change", applyColor);

    // Animation d'ouverture
    document.getElementById("toggleVantaux").addEventListener("click", () => {
      const vantail = scene.getMeshByName("Vantail_1");
      if (vantail) {
        BABYLON.Animation.CreateAndStartAnimation(
          "openVantail",
          vantail,
          "rotation.y",
          30,
          60,
          0,
          Math.PI / 2,
          0
        );
      }
    });

    // Mise à jour dimensions (exemple simplifié)
    function updateModel() {
  const userWidth = parseFloat(document.getElementById("width").value);
  const userHeight = parseFloat(document.getElementById("height").value);
  const addAllege = document.getElementById("addAllege").checked;
  const addImposte = document.getElementById("addImposte").checked;
  const allegeHeight = parseFloat(document.getElementById("allegeHeight").value) || 0;
  const imposteHeight = parseFloat(document.getElementById("imposteHeight").value) || 0;

  const baseWidth = 1000;
  const baseHeight = 1000;

  // Hauteur utile hors allège et imposte
  const effectiveHeight = userHeight - (addAllege ? allegeHeight : 0) - (addImposte ? imposteHeight : 0);

  const scaleX = userWidth / baseWidth;
  const scaleY = effectiveHeight - baseHeight;

      loadedMeshes.forEach(mesh => {
        if (mesh.name.includes("Bas") || mesh.name.includes("Haut")) {
          mesh.scaling.x = scaleX;
         if(mesh.name.includes("Haut")){
          mesh.position.y = (effectiveHeight - baseHeight)/1000;
        }
        }
        if (mesh.name.includes("Gauche") || mesh.name.includes("Droite")) {
          mesh.scaling.y = scaleY;
          if(mesh.name.includes("Droite")){
          mesh.position.x = (userWidth - baseWidth)/1000;
        }
        }
        if (mesh.name.includes("Allege")) {
          mesh.setEnabled(addAllege);
        }
        if (mesh.name.includes("Imposte")) {
          mesh.setEnabled(addImposte);
        }
      });
    }



    document.getElementById("updateBtn").addEventListener("click", updateModel);

    engine.runRenderLoop(() => scene.render());
    window.addEventListener("resize", () => engine.resize());
  </script>
</body>
</html>
